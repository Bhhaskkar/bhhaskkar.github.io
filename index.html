<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>RC Form â†’ Exact PDF</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  * { box-sizing:border-box; }
  body { font-family: Arial, sans-serif; background:#fff; color:#111; padding:18px; }
  h1 { text-align:center; margin:6px 0 18px; font-size:22px; }
  .container { max-width:1100px; margin:0 auto; }
  .form-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; align-items:start; }
  .field {}
  label { display:block; font-weight:600; font-size:13px; margin-bottom:4px; }
  input[type="text"], textarea { width:100%; padding:8px 10px; border:1px solid #d7d7d7; border-radius:4px; font-size:14px; background:#fafafa; }
  textarea { resize:vertical; }
  input[type="file"] { padding:4px; font-size:13px; }
  .wide { grid-column:1 / 4; }
  .actions { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:18px; }
  button { border:none; border-radius:4px; padding:9px 16px; font-weight:600; cursor:pointer; min-width:130px; background:#d9534f; color:#fff; }
  button.secondary { background:#6c757d; }
  .note { text-align:center; font-size:13px; color:#666; margin-top:8px; }
  #preview { display:none; border:1px dashed #ccc; padding:10px; border-radius:6px; margin-top:14px; text-align:center; font-size:12px; }
  #qrcode { margin:8px auto; }
  @media (max-width:900px) { .form-grid { grid-template-columns:1fr 1fr; } .wide { grid-column:1 / 3; } }
  @media (max-width:600px) { .form-grid { grid-template-columns:1fr; } .wide { grid-column:1; } }
</style>
</head>
<body>
<div class="container">
  <h1>RC Form</h1>
  <p class="note">
    This generates a PDF with the same page size, text positions.<br>
    Layout is drawn directly with jsPDF using coordinates extracted from that PDF.
  </p>

  <!-- FORM -->
  <form id="rcForm">
    <div class="form-grid">
      <!-- Form fields -->
      <div class="field"><label>Regn No</label><input id="regnNo" type="text"></div>
      <div class="field"><label>Chassis No</label><input id="chassisNo" type="text"></div>
      <div class="field"><label>No. Of Cyl</label><input id="noCyc" type="text"></div>
      <div class="field"><label>Regn Date</label><input id="regnDate" type="text"></div>
      <div class="field"><label>Engine No</label><input id="engineNo" type="text"></div>
      <div class="field"><label>Owner Serial</label><input id="ownerSerial" type="text"></div>
      <div class="field"><label>Manufacturar</label><input id="manufacturar" type="text"></div>
      <div class="field"><label>Model No</label><input id="modelNo" type="text"></div>
      <div class="field"><label>Tax Paid Up To</label><input id="taxPaid" type="text"></div>
      <div class="field"><label>Fuel</label><input id="fuel" type="text"></div>
      <div class="field"><label>Regd. Owner</label><input id="regdOwner" type="text"></div>
      <div class="field"><label>Regd. Validity</label><input id="regdValidity" type="text"></div>
      <div class="field"><label>Vehicle Class</label><input id="vehClass" type="text"></div>
      <div class="field"><label>S/W/D OF</label><input id="swdOf" type="text"></div>
      <div class="field"><label>Colour</label><input id="colour" type="text"></div>
      <div class="field"><label>Body Type</label><input id="bodyType" type="text"></div>
      <div class="field"><label>ADDRESS</label><textarea id="address" rows="2"></textarea></div>
      <div class="field"><label>R.L.W</label><input id="rlw" type="text"></div>
      <div class="field"><label>Seat. Capacity</label><input id="seatCapacity" type="text"></div>
      <div class="field"><label>Unladen Wt</label><input id="unladenWt" type="text"></div>
      <div class="field"><label>Issuing Authority</label><input id="issuingAuth" type="text"></div>
      <div class="field"><label>Stand. Capacity</label><input id="standCapacity" type="text"></div>
      <div class="field"><label>Cubic Capacity</label><input id="cubic" type="text"></div>
      <div class="field"><label>PURPOSE</label><input id="purpose" type="text"></div>
      <div class="field"><label>Manufacturing Dt</label><input id="mfgDt" type="text"></div>
      <div class="field"><label>Wheel Base</label><input id="wheelBase" type="text"></div>
      <div class="field"><label>Hypothecated To</label><input id="hypo" type="text"></div>
      <div class="field wide"><label>Issuing Authority Sign (optional)</label><input id="signFile" type="file" accept="image/*"></div>
    </div>

    <div class="actions">
      <button type="button" id="btnPdf">Download as PDF</button>
      <button type="reset" class="secondary">Reset</button>
      <button type="button" id="btnQr" class="secondary">Preview QR only</button>
      <button type="button" id="btnScan" class="secondary">Scan Document</button>
    </div>
  </form>

  <div id="preview">
    <div id="qrcode"></div>
    <div id="qrPayload"></div>
  </div>
  <p class="note">
    QR encodes Regn No, Chassis No, Engine No, and the path to Credentials
  </p>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script>
window.addEventListener('DOMContentLoaded', () => {

  const referencePdfPath = "System.Pdf";

  function collect() {
    return {
      regnNo: document.getElementById("regnNo").value.trim(),
      regnDate: document.getElementById("regnDate").value.trim(),
      manufact: document.getElementById("manufacturar").value.trim(),
      fuel: document.getElementById("fuel").value.trim(),
      vehClass: document.getElementById("vehClass").value.trim(),
      bodyType: document.getElementById("bodyType").value.trim(),
      seatCapacity: document.getElementById("seatCapacity").value.trim(),
      standCapacity: document.getElementById("standCapacity").value.trim(),
      mfgDt: document.getElementById("mfgDt").value.trim(),
      chassisNo: document.getElementById("chassisNo").value.trim(),
      engineNo: document.getElementById("engineNo").value.trim(),
      modelNo: document.getElementById("modelNo").value.trim(),
      hypoto: document.getElementById("hypo").value.trim(),
      ownerSerial: document.getElementById("ownerSerial").value.trim(),
      taxPaid: document.getElementById("taxPaid").value.trim(),
      colour: document.getElementById("colour").value.trim(),
      regdOwner: document.getElementById("regdOwner").value.trim(),
      swdof: document.getElementById("swdOf").value.trim(),
      addr: document.getElementById("address").value.trim(),
      rlw: document.getElementById("rlw").value.trim(),
      unladen: document.getElementById("unladenWt").value.trim(),
      issuingAuth: document.getElementById("issuingAuth").value.trim(),
      regdValidity: document.getElementById("regdValidity").value.trim(),
      signatureFile: document.getElementById("signFile").files[0],
      purpose: document.getElementById("purpose").value.trim(),
      cubic: document.getElementById("cubic").value.trim(),
      noCyc: document.getElementById("noCyc").value.trim(),
      wheelBase: document.getElementById("wheelBase").value.trim()
    };
  }

  async function loadImageAsDataURL(file) {
    if (!file) return null;
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  async function generateQrDataUrl(text) {
    return new Promise((resolve, reject) => {
      const temp = document.createElement("div");
      temp.style.position = "fixed";
      temp.style.left = "-9999px";
      temp.style.top = "-9999px";
      document.body.appendChild(temp);
      new QRCode(temp, { text, width:117, height:117, correctLevel: QRCode.CorrectLevel.H });
      setTimeout(() => {
        const canvas = temp.querySelector("canvas");
        const img = temp.querySelector("img");
        let dataUrl = canvas ? canvas.toDataURL("image/png") : img ? img.src : null;
        document.body.removeChild(temp);
        if (dataUrl) resolve(dataUrl);
        else reject(new Error("QR generation failed"));
      }, 300);
    });
  }

  function splitAddress(addr) {
    if (!addr) return ["",""];
    if (addr.includes("\n")) {
      const lines = addr.split("\n");
      return [lines[0], lines.slice(1).join(" ")];
    }
    const idx = addr.indexOf(",");
    if (idx > -1) return [addr.slice(0,idx), addr.slice(idx+1)];
    return [addr,""];
  }

  async function createPdf() {
    const d = collect();
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "pt", format: [594.95996, 841.91998] });

    const signDataUrl = await loadImageAsDataURL(d.signatureFile);
    if (signDataUrl) pdf.addImage(signDataUrl, "PNG", 182, 131, 34, 12);

    const drawBold = (text,x,y,size)=>{ if(text) { pdf.setFont("helvetica"); pdf.setFontSize(size); pdf.text(String(text),x,y); }};
    const drawNormal = (text,x,y,size=4.8)=>{ if(text) { pdf.setFont("helvetica","normal"); pdf.setFontSize(size); pdf.text(String(text),x,y); }};

    const [addr1, addr2] = splitAddress(d.addr);

    drawBold(d.regnNo,46.9609,9.0,5.1750);
    drawBold(d.regdOwner,46.9609,15.0,5.1750);
    drawBold(d.swdof,46.9609,21.75,5.1750);
    drawBold(d.mfgDt,132,33.75,5.1750);
    drawBold(d.regnDate,46.9609,33.75,5.1750);
    drawBold(d.colour,46.9609,39.75,4.35);
    drawBold(d.fuel,46.9609,44.25,4.35);
    drawBold(d.vehClass,46.9609,49.5,4.35);
    drawBold(d.bodyType,46.9609,54.75,4.35);
    drawBold(d.manufact,46.9609,60.0,4.35);
    drawBold(d.chassisNo,46.9609,66,5.175);
    drawBold(d.engineNo,46.9609,72,5.175);
    drawBold(d.modelNo,46.9609,78,5.175);
    drawBold(d.hypoto,120.4,83.75,4.725);
    drawBold(d.noCyc,166,97.5,4.725);
    drawBold(d.ownerSerial,166,104,5.175);
    drawBold(d.taxPaid,203,26.75,5.175);
    drawBold(d.regdValidity,203,33.75,5.175);
    drawBold(d.seatCapacity,122.4,97.5,5.175);
    drawBold(d.standCapacity,122.42,104,5.175);
    drawBold(d.unladen,205,87.75,5.175);
    drawBold(d.cubic,205,93.75,5.175);
    drawBold(d.wheelBase,205,99.75,5.175);
    drawBold(d.rlw,205,105.75,5.175);
    drawBold(addr1,107.0664,115.75,5.175);
    drawBold(addr2,107.0664,121.75,5.175);
    drawNormal(d.issuingAuth,105,141,5.625);

    const qrPayloadObj = { RegnNo:d.regnNo, ChassisNo:d.chassisNo, EngineNo:d.engineNo,RegnDate: d.regnDate, pdf:referencePdfPath };
    try {
      const qrDataUrl = await generateQrDataUrl(JSON.stringify(qrPayloadObj));
      if(qrDataUrl) pdf.addImage(qrDataUrl,"PNG",4.1,80.75,74,74);
    } catch(e){console.error(e);}

    const fileName = (d.regnNo || "RC_output").replace(/\s+/g,"_")+".pdf";
    pdf.save(fileName);
  }

  // Button Listeners
  document.getElementById("btnPdf").addEventListener("click", createPdf);

  document.getElementById("btnQr").addEventListener("click", ()=>{
    const d = collect();
    const payload = JSON.stringify({ RegnNo:d.regnNo, ChassisNo:d.chassisNo, EngineNo:d.engineNo,RegnDate: d.regnDate, pdf:referencePdfPath });
    document.getElementById("preview").style.display="block";
    document.getElementById("qrPayload").textContent = payload;
    const el = document.getElementById("qrcode"); el.innerHTML="";
    new QRCode(el,{text:payload,width:170,height:170,correctLevel:QRCode.CorrectLevel.H});
  });

  document.getElementById("rcForm").addEventListener("reset",()=>{
    setTimeout(()=>{
      document.getElementById("preview").style.display="none";
      document.getElementById("qrcode").innerHTML="";
      document.getElementById("qrPayload").textContent="";
    },0);
  });

  // --- Scan Document Button ---
  document.getElementById("btnScan").addEventListener("click", async ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";
    input.onchange = async e => {
      const file = e.target.files[0];
      if(!file) return;
      const dataUrl = await loadImageAsDataURL(file);
      const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng', { logger: m => console.log(m) });
      console.log("OCR Result:", text);

      // Simple regex auto-fill (adjust patterns as needed)
      const setValue = (id, pattern) => {
        const match = text.match(pattern);
        if(match) document.getElementById(id).value = match[1].trim();
      };
      setValue("regnNo", /Regn No[:\s]*([A-Z0-9-]+)/i);
      setValue("chassisNo", /Chassis No[:\s]*([A-Z0-9-]+)/i);
      setValue("engineNo", /Engine No[:\s]*([A-Z0-9-]+)/i);
      setValue("regdOwner", /Owner[:\s]*([A-Z ]+)/i);
      setValue("fuel", /Fuel[:\s]*([A-Z]+)/i);
      setValue("colour", /Colour[:\s]*([A-Z]+)/i);
      setValue("manufacturar", /Manufacturar[:\s]*([A-Z0-9 ]+)/i);
      // Add more regex as needed
      alert("OCR scanned text applied to form (check console for full text).");
    };
    input.click();
  });

});
</script>
</body>
</html>
